(()=>{"use strict";const e={formSelector:".form",inputSelector:".form__input",submitButtonSelector:".form__submit-button",inactiveButtonClass:"form__submit-button_inactive",inputErrorClass:"form__input_type_error"},t=document.querySelector(".popup_type_edit"),s=document.querySelector(".popup_type_add"),i=document.querySelector(".popup_type_avatar"),n=document.querySelector(".popup_type_confirm"),r=document.querySelector(".profile__edit-button"),o=document.querySelector(".profile__add-button"),a=document.querySelector(".profile__avatar-edit-button"),l=t.querySelector(".form"),h=s.querySelector(".form"),d=i.querySelector(".form"),_=l.querySelector(".form__input_value_name"),c=l.querySelector(".form__input_value_position"),u=t.querySelector(".form__submit-button"),p=s.querySelector(".form__submit-button"),m=i.querySelector(".form__submit-button"),f=n.querySelector(".form__submit-button"),v=document.querySelector(".profile__name"),k=document.querySelector(".profile__position"),y=document.querySelector(".profile__avatar");class E{constructor(e,t,s,i,n,r,o){this._data=e,this._cardSelector=t,this._like=s,this._dislike=i,this._userId=n,this._handleDeleteClick=r,this._handleCardClick=o}_getTemplate(){return document.querySelector(this._cardSelector).content.querySelector(".card").cloneNode(!0)}_getImage(){return this._element.querySelector(".card__image")}_getDeleteButton(){return this._element.querySelector(".card__delete")}_getLikeButton(){return this._element.querySelector(".card__like")}_getLikesCounter(){return this._element.querySelector(".card__likes-amount")}_getLikesAmount(e){this._likesCounter.textContent=e.likes.length}_setInitialCardSettings(){this._getLikesAmount(this._data),this._data.likes.some((e=>e._id===this._userId))&&this._cardLike.classList.add("card__like_active"),this._data.owner._id!==this._userId&&this._cardDelete.remove()}_handleLike(){this._like(this._data._id).then((e=>{this._cardLike.classList.add("card__like_active"),this._getLikesAmount(e)})).catch((e=>console.log(e)))}_handleDislike(){this._dislike(this._data._id).then((e=>{this._cardLike.classList.remove("card__like_active"),this._getLikesAmount(e)})).catch((e=>console.log(e)))}_setEventListeners(){this._image.addEventListener("click",(()=>{this._handleCardClick()})),this._cardDelete.addEventListener("click",(()=>{this._handleDeleteClick()})),this._cardLike.addEventListener("click",(()=>{this._cardLike.classList.contains("card__like_active")?this._handleDislike():this._handleLike()}))}deleteCard(){this._element.remove(),this._element=null}generateCard(){return this._element=this._getTemplate(),this._image=this._getImage(),this._image.src=this._data.link,this._image.alt=this._data.name,this._cardDelete=this._getDeleteButton(),this._cardLike=this._getLikeButton(),this._likesCounter=this._getLikesCounter(),this._element.querySelector(".card__heading").textContent=this._data.name,this._setInitialCardSettings(),this._setEventListeners(),this._element}}class S{constructor(e,t){this._obj=e,this._formElement=t,this._inputList=Array.from(this._formElement.querySelectorAll(this._obj.inputSelector)),this._buttonElement=this._formElement.querySelector(this._obj.submitButtonSelector)}_showInputError(e){const t=document.getElementById(`${e.id}-error`);e.classList.add(this._obj.inputErrorClass),t.textContent=e.validationMessage}_hideInputError(e){const t=document.getElementById(`${e.id}-error`);e.classList.remove(this._obj.inputErrorClass),t.textContent=""}_checkInputValidity(e){e.validity.valid?this._hideInputError(e):this._showInputError(e)}_hasInvalidInput(e){return e.some((e=>!e.validity.valid))}_enableSubmitButton(e){e.classList.remove(this._obj.inactiveButtonClass),e.removeAttribute("disabled")}_disableSubmitButton(e){e.classList.add(this._obj.inactiveButtonClass),e.setAttribute("disabled",!0)}_toggleButtonState(e,t){this._hasInvalidInput(e)?this._disableSubmitButton(t):this._enableSubmitButton(t)}_setEventListeners=()=>{this._toggleButtonState(this._inputList,this._buttonElement),this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState(this._inputList,this._buttonElement)}))}))};enableValidation(){this._formElement.addEventListener("submit",(function(e){e.preventDefault()})),this._setEventListeners()}resetValidation(e){this._inputList.forEach((t=>{this._toggleButtonState(this._inputList,e),this._hideInputError(t)}))}}class g{constructor(e){this._popupElement=document.querySelector(e)}open(){this._popupElement.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popupElement.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose=e=>{"Escape"===e.key&&this.close()};setEventListeners(){this._popupElement.addEventListener("click",(e=>{(e.target.classList.contains("popup__close")||e.target===e.currentTarget)&&this.close()}))}}class L extends g{constructor({popupSelector:e,handleFormSubmit:t}){super(e),this._handleFormSubmit=t,this._form=this._popupElement.querySelector(".form"),this._inputList=Array.from(this._popupElement.querySelectorAll(".form__input"))}_getInputValues(){return this._formValues={},this._inputList.forEach((e=>{this._formValues[e.name]=e.value})),this._formValues}setEventListeners(){super.setEventListeners(),this._popupElement.addEventListener("submit",(e=>{e.preventDefault(),this._handleFormSubmit(this._getInputValues())}))}close(){this._form.reset(),super.close()}}function b(e,t,s){t.textContent=e?"Сохранение...":s}function C(e){const t=new E(e,".card-template",$,A,"b02aa1771eae819636737318",(()=>{U.open(),U.handleConfirm((()=>{b(!0,f),w.deleteCard(e._id).then((()=>t.deleteCard())).then(U.close.bind(U)).catch((e=>console.log(e))).finally((()=>{b(!1,f,"Да")}))}))}),(()=>{V.open({name:e.name,link:e.link})}));return t.generateCard()}const I=new class{constructor({renderer:e},t){this._renderer=e,this._container=document.querySelector(t)}renderItems(e){e.forEach((e=>{this._renderer(e)}))}addItem(e){this._container.prepend(e)}}({renderer:e=>{I.addItem(C(e))}},".cards__container"),q=new class{constructor(e,t,s){this._profileName=e,this._profilePosition=t,this._profileAvatar=s}getUserInfo(){return{profileNameInput:this._profileName.textContent,profileInfoInput:this._profilePosition.textContent}}setUserInfo(e,t){this._profileName.textContent=e,this._profilePosition.textContent=t}setUserAvatar(e){this._profileAvatar.src=e}}(v,k,y),w=new class{constructor(e){this.link=e.link,this.headers=e.headers}_handleResponse=e=>e.ok?e.json():Promise.reject("Ошибка");getUserInfo(){return fetch(`${this.link}/users/me`,{method:"GET",headers:this.headers}).then(this._handleResponse)}getInitialCard(){return fetch(`${this.link}/cards`,{method:"GET",headers:this.headers}).then(this._handleResponse)}setUserInfo(e,t){return fetch(`${this.link}/users/me`,{method:"PATCH",headers:this.headers,body:JSON.stringify({name:`${e}`,about:`${t}`})}).then(this._handleResponse)}addNewCard(e,t){return fetch(`${this.link}/cards`,{method:"POST",headers:this.headers,body:JSON.stringify({name:`${e}`,link:`${t}`})}).then(this._handleResponse)}addNewAvatar(e){return fetch(`${this.link}/users/me/avatar`,{method:"PATCH",headers:this.headers,body:JSON.stringify({avatar:`${e}`})}).then(this._handleResponse)}deleteCard(e){return fetch(`${this.link}/cards/${e}`,{method:"DELETE",headers:this.headers,body:JSON.stringify({_id:`${e}`})}).then(this._handleResponse)}like(e){return fetch(`${this.link}/cards/${e}/likes`,{method:"PUT",headers:this.headers,body:JSON.stringify({_id:`${e}`})}).then(this._handleResponse)}dislike(e){return fetch(`${this.link}/cards/${e}/likes`,{method:"DELETE",headers:this.headers,body:JSON.stringify({_id:`${e}`})}).then(this._handleResponse)}}({link:"https://mesto.nomoreparties.co/v1/apf-cohort-202/",headers:{authorization:"731c9758-29e7-4522-a73a-38f85292c240","Content-Type":"application/json"}});Promise.all([w.getUserInfo(),w.getInitialCard()]).then((([e,t])=>{q.setUserAvatar(e.avatar),q.setUserInfo(e.name,e.about),I.renderItems(t.reverse())})).catch((e=>{console.log(e)}));const $=e=>w.like(e),A=e=>w.dislike(e),B=new S(e,l);B.enableValidation();const D=new S(e,h);D.enableValidation();const N=new S(e,d);N.enableValidation();const V=new class extends g{constructor(e){super(e),this._image=this._popupElement.querySelector(".popup__photo"),this._title=this._popupElement.querySelector(".popup__caption")}open(e){super.open(),this._image.src=e.link,this._title.textContent=e.name,this._image.alt=e.name}}(".popup_type_image");V.setEventListeners();const U=new class extends g{constructor(e){super(e)}handleConfirm(e){this._handleDeleteCard=e}setEventListeners(){super.setEventListeners(),this._popupElement.addEventListener("submit",(e=>{e.preventDefault(),this._handleDeleteCard()}))}}(".popup_type_confirm");U.setEventListeners();const x=new L({popupSelector:".popup_type_avatar",handleFormSubmit:e=>{b(!0,m),w.addNewAvatar(e.link).then((e=>{q.setUserAvatar(e.avatar),x.close()})).catch((e=>console.log(e))).finally((()=>{b(!1,m,"Сохранить")}))}});x.setEventListeners();const T=new L({popupSelector:".popup_type_edit",handleFormSubmit:e=>{b(!0,u),w.setUserInfo(e.name,e.position).then((()=>{q.setUserInfo(e.name,e.position),T.close()})).catch((e=>console.log(e))).finally((()=>{b(!1,u,"Сохранить")}))}});T.setEventListeners();const j=new L({popupSelector:".popup_type_add",handleFormSubmit:e=>{b(!0,p),w.addNewCard(e.place,e.link).then((e=>{I.addItem(C(e)),j.close()})).catch((e=>console.log(e))).finally((()=>{b(!1,p,"Создать")}))}});j.setEventListeners(),r.addEventListener("click",(()=>{_.value=q.getUserInfo().profileNameInput,c.value=q.getUserInfo().profileInfoInput,T.open(),B.resetValidation(u)})),o.addEventListener("click",(()=>{j.open(),D.resetValidation(p)})),a.addEventListener("click",(()=>{x.open(),N.resetValidation(m)}))})();